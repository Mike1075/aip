import React, { useState, useEffect } from 'react'
import { X, Send, Bot, User, Trash2, Check } from 'lucide-react'
import { callN8nRAGAgent, callN8nRAGAgentLocal, getChatRecords, saveChatRecord, deleteChatMessage, getUserProjects, UserProject } from '../../lib/n8n'
import { Organization, Project } from '@/lib/supabase'
import { useAuth } from '@/contexts/AuthContext'
import { MarkdownRenderer } from '../Common/MarkdownRenderer'

interface AIChatProps {
  onClose: () => void
  organization?: Organization
  currentProject?: Project  // æ–°å¢ï¼šå½“å‰é¡¹ç›®å‚æ•°
  showProjectSelector?: boolean
}

interface ChatMessage {
  id: string
  role: 'user' | 'assistant'
  content: string
  timestamp: Date
}

export function AIChat({ onClose, organization, currentProject, showProjectSelector = true }: AIChatProps) {
  const { user } = useAuth()
  const [messages, setMessages] = useState<ChatMessage[]>([])
  const [input, setInput] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [selectedProjects, setSelectedProjects] = useState<string[]>([])
  const [selectedOrganizations, setSelectedOrganizations] = useState<string[]>([])
  const [isProjectSelectorExpanded, setIsProjectSelectorExpanded] = useState(false)
  const [isOrganizationSelectorExpanded, setIsOrganizationSelectorExpanded] = useState(false)
  const [isLoadingHistory, setIsLoadingHistory] = useState(true)
  const [showContextPanel, setShowContextPanel] = useState(true) // æ–°å¢ï¼šä¾§è¾¹ä¸Šä¸‹æ–‡é¢æ¿
  const [userProjects, setUserProjects] = useState<UserProject[]>([])
  const [isLoadingProjects, setIsLoadingProjects] = useState<boolean>(false)

  // åˆå§‹åŒ–æ—¶è‡ªåŠ¨é¢„é€‰å½“å‰é¡¹ç›®å’Œç»„ç»‡
  useEffect(() => {
    if (currentProject) {
      setSelectedProjects([currentProject.id])
      console.log('ğŸ¯ è‡ªåŠ¨é¢„é€‰å½“å‰é¡¹ç›®:', currentProject.name, currentProject.id)
    }
    
    if (organization) {
      setSelectedOrganizations([organization.id])
      console.log('ğŸ¢ è‡ªåŠ¨é¢„é€‰å½“å‰ç»„ç»‡:', organization.name, organization.id)
    }
  }, [currentProject, organization])

  // åŠ è½½ç”¨æˆ·çš„å…¨éƒ¨é¡¹ç›®ï¼ˆå¯ç»“åˆç»„ç»‡ä¸Šä¸‹æ–‡å®šåˆ¶ï¼Œè¿™é‡ŒæŒ‰â€œæ‰€æœ‰è‡ªå·±çš„é¡¹ç›®â€ï¼Œå¦‚æœ‰ç»„ç»‡ä¸Šä¸‹æ–‡åˆ™è¿‡æ»¤è¯¥ç»„ç»‡ï¼‰
  useEffect(() => {
    const load = async () => {
      try {
        setIsLoadingProjects(true)
        const projects = await getUserProjects()
        // å¦‚æœå­˜åœ¨ç»„ç»‡ä¸Šä¸‹æ–‡ï¼ˆæ¥è‡ªé¡¹ç›®è¯¦æƒ…é¡µæˆ–ç»„ç»‡é¡µï¼‰ï¼Œåªæ˜¾ç¤ºè¯¥ç»„ç»‡ä¸‹çš„é¡¹ç›®
        const filtered = organization?.id
          ? projects.filter(p => p.organization_id === organization.id)
          : projects
        setUserProjects(filtered)
      } catch (err) {
        console.error('åŠ è½½ç”¨æˆ·é¡¹ç›®å¤±è´¥:', err)
      } finally {
        setIsLoadingProjects(false)
      }
    }
    load()
  }, [user?.id, organization?.id])

  // è·å–æ¸…ç©ºç‚¹æ—¶é—´æˆ³
  const getClearTimestamp = (): string | null => {
    return localStorage.getItem('chatClearTimestamp')
  }

  // è®¾ç½®æ¸…ç©ºç‚¹æ—¶é—´æˆ³
  const setClearTimestamp = (timestamp: string) => {
    localStorage.setItem('chatClearTimestamp', timestamp)
  }

  // æ™ºèƒ½åˆ é™¤å•ä¸ªèŠå¤©æ¶ˆæ¯
  const handleDeleteMessage = async (messageId: string, message: ChatMessage) => {
    console.log('ğŸ—‘ï¸ è¯·æ±‚åˆ é™¤æ¶ˆæ¯:', { messageId, role: message.role })

    // 1) æ€»æ˜¯å…ˆç§»é™¤å‰ç«¯æ˜¾ç¤ºï¼ˆä¹è§‚æ›´æ–°ï¼‰
    setMessages(prev => prev.filter(m => m.id !== messageId))

    // 2) åˆ¤æ–­æ˜¯å¦ä¸ºå·²æŒä¹…åŒ–è®°å½•ï¼ˆå½¢å¦‚ user-<uuid> / ai-<uuid>ï¼‰
    const isPersisted = messageId.includes('-')
    if (!isPersisted) {
      console.log('âš ï¸ ä»…å‰ç«¯åˆ é™¤ï¼ˆæœªæŒä¹…åŒ–çš„ä¸´æ—¶æ¶ˆæ¯ï¼‰:', messageId)
      return
    }

    // 3) å°è¯•è§£æè®°å½•IDï¼›è§£æå¤±è´¥ä¹Ÿä»…å‰ç«¯åˆ é™¤
    const parts = messageId.split('-')
    const recordId = parts.slice(1).join('-')
    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i
    if (!recordId || !uuidRegex.test(recordId)) {
      console.log('âš ï¸ éæ ‡å‡†IDï¼Œå·²ä»…å‰ç«¯åˆ é™¤:', messageId)
      return
    }

    // 4) åç«¯åˆ é™¤ï¼ˆé™é»˜ï¼‰ï¼Œå¤±è´¥ä¸å›æ»šå‰ç«¯
    try {
      const type: 'user' | 'ai' = message.role === 'assistant' ? 'ai' : 'user'
      await deleteChatMessage(recordId, type)
      console.log('âœ… åç«¯åˆ é™¤æˆåŠŸ:', { recordId, type })
    } catch (e) {
      console.warn('âš ï¸ åç«¯åˆ é™¤å¤±è´¥ï¼ˆå·²ä¿æŒå‰ç«¯å·²åˆ æ•ˆæœï¼‰:', e)
    }
  }

  // åˆ·æ–°èŠå¤©å†å²
  const refreshChatHistory = async () => {
    try {
      console.log('ğŸ”„ åˆ·æ–°èŠå¤©å†å²...')
      const records = await getChatRecords(20)
      
      // æ ¹æ®å½“å‰ä¸Šä¸‹æ–‡ç”Ÿæˆæ™ºèƒ½æ¬¢è¿æ¶ˆæ¯
      let welcomeContent = 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIé¡¹ç›®ç®¡ç†åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨å›ç­”é—®é¢˜ã€åˆ†æé¡¹ç›®è¿›åº¦ã€åˆ†é…ä»»åŠ¡ç­‰ã€‚'
      
      if (currentProject && organization) {
        welcomeContent = `æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIé¡¹ç›®ç®¡ç†åŠ©æ‰‹ã€‚å½“å‰å·²ä¸ºæ‚¨é€‰æ‹©äº†é¡¹ç›®ã€Œ${currentProject.name}ã€ï¼ˆ${organization.name}ç»„ç»‡ï¼‰ã€‚æ‚¨å¯ä»¥ç›´æ¥è¯¢é—®è¯¥é¡¹ç›®çš„ç›¸å…³é—®é¢˜ï¼Œå¦‚è¿›åº¦ã€ä»»åŠ¡ã€æ–‡æ¡£ç­‰ã€‚`
      } else if (organization) {
        welcomeContent = `æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIé¡¹ç›®ç®¡ç†åŠ©æ‰‹ã€‚å½“å‰å·²ä¸ºæ‚¨é€‰æ‹©äº†ã€Œ${organization.name}ã€ç»„ç»‡ã€‚æ‚¨å¯ä»¥è¯¢é—®è¯¥ç»„ç»‡çš„ç›¸å…³é—®é¢˜ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ç‰¹å®šé¡¹ç›®è¿›è¡Œæ›´ç²¾å‡†çš„æŸ¥è¯¢ã€‚`
      } else {
        welcomeContent = 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIé¡¹ç›®ç®¡ç†åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨å›ç­”é—®é¢˜ã€åˆ†æé¡¹ç›®è¿›åº¦ã€åˆ†é…ä»»åŠ¡ç­‰ã€‚æ‚¨å¯ä»¥ç›´æ¥å¼€å§‹å¯¹è¯ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ç‰¹å®šé¡¹ç›®è¿›è¡Œæ›´ç²¾å‡†çš„æŸ¥è¯¢ã€‚'
      }
      
      const welcomeMessage: ChatMessage = {
        id: 'welcome',
        role: 'assistant',
        content: welcomeContent,
        timestamp: new Date()
      }
      
      // è·å–æ¸…ç©ºç‚¹æ—¶é—´æˆ³
      const clearTimestamp = getClearTimestamp()
      
      if (records.length > 0) {
        let filteredRecords = records
        
        // å¦‚æœæœ‰æ¸…ç©ºç‚¹ï¼Œåªæ˜¾ç¤ºæ¸…ç©ºç‚¹ä¹‹åçš„è®°å½•
        if (clearTimestamp) {
          const clearTime = new Date(clearTimestamp)
          filteredRecords = records.filter(record => {
            const recordTime = new Date(record.created_at)
            return recordTime > clearTime
          })
        }
        
        if (filteredRecords.length > 0) {
          const historyMessages: ChatMessage[] = []
          
          filteredRecords.reverse().forEach((record) => {
            // åªæœ‰å½“contentä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            if (record.content && record.content.trim() !== '') {
              historyMessages.push({
                id: `user-${record.id}`,
                role: 'user',
                content: record.content,
                timestamp: new Date(record.created_at)
              })
            }
            
            // åªæœ‰å½“ai_contentä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ AIå›å¤
            if (record.ai_content && record.ai_content.trim() !== '') {
              historyMessages.push({
                id: `ai-${record.id}`,
                role: 'assistant',
                content: record.ai_content,
                timestamp: new Date(record.created_at)
              })
            }
          })
          
          setMessages([welcomeMessage, ...historyMessages])
          console.log('âœ… èŠå¤©å†å²åˆ·æ–°å®Œæˆ')
        } else {
          setMessages([welcomeMessage])
        }
      } else {
        setMessages([welcomeMessage])
      }
    } catch (error) {
      console.error('âŒ åˆ·æ–°èŠå¤©å†å²å¤±è´¥:', error)
    }
  }

  // åˆå§‹åŒ–èŠå¤©çª—å£ - æ˜¾ç¤ºæ¸…ç©ºç‚¹ä¹‹åçš„å†å²è®°å½•
  useEffect(() => {
    const initializeChat = async () => {
      try {
        console.log('ğŸ” åˆå§‹åŒ–èŠå¤©çª—å£...')
        const records = await getChatRecords(20)
        
        const welcomeMessage: ChatMessage = {
          id: 'welcome',
          role: 'assistant',
          content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIé¡¹ç›®ç®¡ç†åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨å›ç­”é—®é¢˜ã€åˆ†æé¡¹ç›®è¿›åº¦ã€åˆ†é…ä»»åŠ¡ç­‰ã€‚æ‚¨å¯ä»¥ç›´æ¥å¼€å§‹å¯¹è¯ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ç‰¹å®šé¡¹ç›®è¿›è¡Œæ›´ç²¾å‡†çš„æŸ¥è¯¢ã€‚',
          timestamp: new Date()
        }
        
        // è·å–æ¸…ç©ºç‚¹æ—¶é—´æˆ³
        const clearTimestamp = getClearTimestamp()
        
        if (records.length > 0) {
          let filteredRecords = records
          
          // å¦‚æœæœ‰æ¸…ç©ºç‚¹ï¼Œåªæ˜¾ç¤ºæ¸…ç©ºç‚¹ä¹‹åçš„è®°å½•
          if (clearTimestamp) {
            const clearTime = new Date(clearTimestamp)
            filteredRecords = records.filter(record => {
              const recordTime = new Date(record.created_at)
              return recordTime > clearTime
            })
            console.log(`ğŸ”„ è¿‡æ»¤è®°å½•: æ¸…ç©ºç‚¹${clearTimestamp}ä¹‹åæœ‰${filteredRecords.length}æ¡è®°å½•`)
          }
          
          if (filteredRecords.length > 0) {
            const historyMessages: ChatMessage[] = []
            
            filteredRecords.reverse().forEach((record) => {
              // åªæœ‰å½“contentä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
              if (record.content && record.content.trim() !== '') {
                historyMessages.push({
                  id: `user-${record.id}`,
                  role: 'user',
                  content: record.content,
                  timestamp: new Date(record.created_at)
                })
              }
              
              // åªæœ‰å½“ai_contentä¸ä¸ºç©ºæ—¶æ‰æ·»åŠ AIå›å¤
              if (record.ai_content && record.ai_content.trim() !== '') {
                historyMessages.push({
                  id: `ai-${record.id}`,
                  role: 'assistant',
                  content: record.ai_content,
                  timestamp: new Date(record.created_at)
                })
              }
            })
            
            setMessages([welcomeMessage, ...historyMessages])
            console.log('âœ… å†å²è®°å½•åŠ è½½å®Œæˆ')
          } else {
            setMessages([welcomeMessage])
            console.log('âœ… æ¸…ç©ºç‚¹ä¹‹åæ— æ–°è®°å½•ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯')
          }
        } else {
          setMessages([welcomeMessage])
          console.log('âœ… æ— å†å²è®°å½•ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯')
        }
      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error)
        setMessages([{
          id: 'welcome',
          role: 'assistant',
          content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIé¡¹ç›®ç®¡ç†åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨åˆ†æé¡¹ç›®è¿›åº¦ã€åˆ†é…ä»»åŠ¡ã€å›ç­”é—®é¢˜ã€‚è¯·é€‰æ‹©è¦æŸ¥è¯¢çš„é¡¹ç›®ï¼Œç„¶åè¾“å…¥æ‚¨çš„é—®é¢˜ã€‚',
          timestamp: new Date()
        }])
      } finally {
        setIsLoadingHistory(false)
      }
    }

    initializeChat()
  }, [])

  // æ¸…ç©ºèŠå¤©è®°å½•ï¼ˆè®¾ç½®æ¸…ç©ºç‚¹ï¼‰
  const handleClearSession = () => {
    const currentTime = new Date().toISOString()
    setClearTimestamp(currentTime)
    
    const welcomeMessage: ChatMessage = {
      id: 'welcome',
      role: 'assistant',
      content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIé¡¹ç›®ç®¡ç†åŠ©æ‰‹ã€‚è¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„å¯¹è¯ä¼šè¯ã€‚è¯·é€‰æ‹©è¦æŸ¥è¯¢çš„é¡¹ç›®ï¼Œç„¶åè¾“å…¥æ‚¨çš„é—®é¢˜ã€‚',
      timestamp: new Date()
    }
    setMessages([welcomeMessage])
    console.log('âœ… æ¸…ç©ºç‚¹å·²è®¾ç½®:', currentTime)
  }

  const handleSend = async () => {
    if (!input.trim()) return
    
    // å…è®¸åœ¨æ²¡æœ‰é€‰æ‹©é¡¹ç›®çš„æƒ…å†µä¸‹ä¹Ÿèƒ½èŠå¤©
    // åªæœ‰åœ¨æ—¢æ²¡æœ‰é€‰æ‹©é¡¹ç›®ä¹Ÿæ²¡æœ‰ç»„ç»‡ä¸Šä¸‹æ–‡æ—¶æ‰æç¤º
    // if (selectedProjects.length === 0 && !organization?.id) {
    //   alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªé¡¹ç›®æˆ–ç¡®ä¿åœ¨ç»„ç»‡é¡µé¢ä¸­')
    //   return
    // }

    const newMessage: ChatMessage = {
      id: Date.now().toString(),
      role: 'user',
      content: input.trim(),
      timestamp: new Date()
    }

    setMessages(prev => [...prev, newMessage])
    setInput('')
    setIsLoading(true)

    try {
      // æ ¹æ®é€‰æ‹©æƒ…å†µå†³å®šä¼ é€’çš„å‚æ•°ï¼ˆä»…é™å½“å‰ç»„ç»‡ï¼‰
      let projectId: string | string[] | undefined = undefined
      if (selectedProjects.length > 0) {
        // è¿‡æ»¤æ‰ä¸å±äºå½“å‰ç»„ç»‡çš„é¡¹ç›®ï¼ˆå®‰å…¨å…œåº•ï¼‰
        const allowed = organization?.id
          ? selectedProjects.filter(id => userProjects.find(p => p.id === id && p.organization_id === organization.id))
          : selectedProjects
        if (allowed.length > 0) {
          projectId = allowed.length === 1 ? allowed[0] : allowed
        }
      }

      // ç»„ç»‡IDï¼šå¼ºåˆ¶ä½¿ç”¨å½“å‰ç»„ç»‡ä¸Šä¸‹æ–‡ï¼Œç¦æ­¢è·¨ç»„ç»‡
      const organizationId = organization?.id || ''

      const result = await callN8nRAGAgentLocal(
        input.trim(), 
        projectId, 
        organizationId
      )

      // æ¸…ç†AIå›å¤ä¸­çš„è½¬ä¹‰å­—ç¬¦
      let aiResponseContent = result.success ? result.response || 'æ”¶åˆ°å›å¤ä½†å†…å®¹ä¸ºç©º' : `è°ƒç”¨å¤±è´¥: ${result.error}`
      
      if (result.success && result.response) {
        aiResponseContent = result.response
          .replace(/\\n\\n/g, '\n\n')  // å°† \n\n è½¬æ¢ä¸ºçœŸæ­£çš„æ¢è¡Œ
          .replace(/\\n/g, '\n')       // å°† \n è½¬æ¢ä¸ºçœŸæ­£çš„æ¢è¡Œ
          .replace(/\\t/g, '\t')       // å¤„ç†åˆ¶è¡¨ç¬¦
          .replace(/\\"/g, '"')        // å¤„ç†å¼•å·
          .replace(/\\\\/g, '\\')      // å¤„ç†åæ–œæ 
          .trim()                      // å»é™¤é¦–å°¾ç©ºç™½
      }
      
      const aiResponse: ChatMessage = {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: aiResponseContent,
        timestamp: new Date()
      }
      
      setMessages(prev => [...prev, aiResponse])

      // å‰ç«¯ä¸å†ä¿å­˜èŠå¤©è®°å½•åˆ°æ•°æ®åº“ï¼Œç”±n8nå·¥ä½œæµå¤„ç†
      // if (result.success) {
      //   await saveChatRecord(input.trim(), aiResponseContent, projectId)
      // }
    } catch (error) {
      const errorResponse: ChatMessage = {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: `ç³»ç»Ÿé”™è¯¯: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`,
        timestamp: new Date()
      }
      setMessages(prev => [...prev, errorResponse])
    } finally {
      setIsLoading(false)
    }
  }

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSend()
    }
  }

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      {/* ä½¿ç”¨å¹¶æ’å¸ƒå±€ï¼šå·¦ä¾§èŠå¤©çª— + å³ä¾§ä¸Šä¸‹æ–‡é¢æ¿ */}
      <div className="flex items-start gap-4 mx-4 max-w-[1320px] w-full">
        <div className="bg-white rounded-xl shadow-xl w-full max-w-[960px] h-[600px] flex flex-col">
        {/* å¤´éƒ¨ */}
        <div className="flex items-center justify-between p-4 border-b border-secondary-200">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-primary-100 rounded-lg">
              <Bot className="h-5 w-5 text-primary-600" />
            </div>
            <div>
              <h3 className="font-medium text-secondary-900">AIé¡¹ç›®åŠ©æ‰‹</h3>
              <p className="text-sm text-secondary-500">æ™ºèƒ½é¡¹ç›®ç®¡ç†é¡¾é—®</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <button
              onClick={handleClearSession}
              className="p-2 hover:bg-secondary-100 rounded-lg transition-colors group"
              title="æ¸…ç©ºèŠå¤©è®°å½•"
            >
              <Trash2 className="h-4 w-4 text-secondary-500 group-hover:text-red-500" />
            </button>
            <button
              onClick={onClose}
              className="p-2 hover:bg-secondary-100 rounded-lg transition-colors"
            >
              <X className="h-5 w-5 text-secondary-600" />
            </button>
          </div>
        </div>

        {/* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */}
        <div className="flex-1 overflow-y-auto p-4 space-y-4">
          {isLoadingHistory ? (
            <div className="flex items-center justify-center py-8">
              <div className="flex items-center gap-2 text-secondary-500">
                <div className="animate-spin rounded-full h-4 w-4 border-2 border-primary-500 border-t-transparent"></div>
                <span>åŠ è½½ä¸­...</span>
              </div>
            </div>
          ) : (
            <>
                {/* èŠå¤©æ¶ˆæ¯åˆ—è¡¨ */}
              {messages.map((message) => (
            <div
              key={message.id}
              className={`group flex items-start gap-3 ${
                message.role === 'user' ? 'justify-end' : 'justify-start'
              }`}
            >
              {message.role === 'assistant' && (
                <div className="p-2 bg-primary-100 rounded-lg">
                  <Bot className="h-5 w-5 text-primary-600" />
                </div>
              )}
              <div className="flex items-start gap-2">
                <div
                  className={`px-4 py-2 rounded-lg ${
                    message.role === 'user'
                      ? 'bg-primary-600 text-white max-w-xs lg:max-w-md'
                      : 'bg-secondary-100 text-secondary-900 max-w-[85%] w-full'
                  }`}
                >
                  {message.role === 'assistant' ? (
                    <MarkdownRenderer 
                      content={message.content}
                      className="text-sm prose-headings:text-secondary-900 prose-p:text-secondary-900 prose-strong:text-secondary-900"
                    />
                  ) : (
                    <p className="text-sm whitespace-pre-wrap">{message.content}</p>
                  )}
                </div>
                      {/* åˆ é™¤æŒ‰é’® */}
                {message.id !== 'welcome' && (
                  <div className="relative">
                    <button
                      onDoubleClick={(e) => {
                        e.preventDefault()
                        e.stopPropagation()
                        handleDeleteMessage(message.id, message)
                      }}
                      onClick={(e) => {
                        e.preventDefault()
                        e.stopPropagation()
                      }}
                      className={`opacity-30 group-hover:opacity-100 transition-opacity p-1 rounded hover:bg-red-100 peer cursor-pointer ${
                        message.role === 'user' ? 'order-first' : ''
                      }`}
                      title="åŒå‡»åˆ é™¤æ­¤æ¶ˆæ¯"
                    >
                      <X className="h-3 w-3 text-red-500 hover:text-red-700" />
                    </button>
                    <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-1 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 peer-hover:opacity-100 transition-opacity duration-0 pointer-events-none z-10">
                      åŒå‡»åˆ é™¤
                    </div>
                  </div>
                )}
              </div>
              {message.role === 'user' && (
                <div className="p-2 bg-secondary-200 rounded-lg">
                  <User className="h-4 w-4 text-secondary-600" />
                </div>
              )}
            </div>
          ))}
            </>
          )}
          
          {isLoading && (
            <div className="flex items-start gap-3">
              <div className="p-2 bg-primary-100 rounded-lg">
                <Bot className="h-5 w-5 text-primary-600" />
              </div>
              <div className="bg-secondary-100 px-4 py-2 rounded-lg">
                <div className="flex gap-1">
                  <div className="w-2 h-2 bg-secondary-400 rounded-full animate-bounce"></div>
                  <div className="w-2 h-2 bg-secondary-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                  <div className="w-2 h-2 bg-secondary-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* è¾“å…¥åŒºåŸŸ */}
        <div className="p-4 border-t border-secondary-200">
            {/* å½“å‰é¡¹ç›®ä¸Šä¸‹æ–‡æç¤º */}
            {currentProject && organization && (
              <div className="mb-3 p-3 bg-primary-50 border border-primary-200 rounded-lg">
                <div className="flex items-center gap-2 text-sm">
                  <div className="w-2 h-2 bg-primary-500 rounded-full"></div>
                  <span className="text-primary-700">
                    <strong>å½“å‰ä¸Šä¸‹æ–‡ï¼š</strong>é¡¹ç›®ã€Œ{currentProject.name}ã€ï¼ˆ{organization.name}ï¼‰
                </span>
              <button
                    onClick={() => {
                      setSelectedProjects([])
                      setSelectedOrganizations([])
                    }}
                    className="ml-auto text-xs text-primary-600 hover:text-primary-800 underline"
                    title="ç‚¹å‡»åˆ‡æ¢åˆ°å…¨å±€æ¨¡å¼"
                  >
                    åˆ‡æ¢æ¨¡å¼
              </button>
                </div>
            </div>
          )}
          
          <div className="flex items-end gap-3">
            <div className="flex-1">
              <textarea
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyPress={handleKeyPress}
                placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
                className="input resize-none"
                rows={2}
              />
            </div>
            <button
              onClick={handleSend}
              disabled={!input.trim() || isLoading}
              className="btn-primary p-3 disabled:opacity-50 disabled:cursor-not-allowed"
                title="å‘é€"
            >
                <Send className="h-5 w-5" />
            </button>
            </div>
          </div>
        </div>

        {/* ä¾§è¾¹ä¸Šä¸‹æ–‡é¢æ¿ï¼šç®€çº¦é•¿æ¡é¡¹ç›®åˆ—è¡¨ + æ»‘å— */}
        {showContextPanel && (
          <div className="bg-white rounded-xl shadow-xl w-[360px] min-w-[360px] h-[600px] p-4 border border-secondary-200 flex flex-col flex-shrink-0">
            <div className="flex items-center justify-between mb-3">
              <h4 className="text-sm font-semibold text-secondary-900">æˆ‘çš„é¡¹ç›®</h4>
              <label className="inline-flex items-center cursor-pointer select-none text-xs text-secondary-600">
                <input
                  type="checkbox"
                  className="sr-only peer"
                  checked={selectedProjects.length === userProjects.length && userProjects.length > 0}
                  onChange={() => {
                    if (selectedProjects.length === userProjects.length) {
                      setSelectedProjects([])
                    } else {
                      setSelectedProjects(userProjects.map(p => p.id))
                    }
                  }}
                />
                <span className="mr-2">å…¨é€‰</span>
                <span className="w-10 h-5 bg-secondary-200 rounded-full peer-checked:bg-primary-600 relative transition-colors">
                  <span className="absolute left-0 top-0.5 w-4 h-4 bg-white rounded-full shadow transition-all peer-checked:left-6" />
                </span>
              </label>
            </div>

            <div className="flex-1 overflow-y-auto rounded-md border border-secondary-200">
              {isLoadingProjects ? (
                <div className="p-3 text-sm text-secondary-600">åŠ è½½é¡¹ç›®ä¸­...</div>
              ) : userProjects.length === 0 ? (
                <div className="p-3 text-sm text-secondary-600">æš‚æ— é¡¹ç›®</div>
              ) : (
                // æŒ‰ç»„ç»‡åˆ†ç»„
                (() => {
                  const groups = new Map<string, { name?: string; items: typeof userProjects }>()
                  for (const p of userProjects) {
                    const key = p.organization_id || 'unknown'
                    if (!groups.has(key)) groups.set(key, { name: p.organization_name, items: [] as any })
                    groups.get(key)!.items.push(p)
                  }

                  const selectedOrgId = (selectedProjects[0] && userProjects.find(x => x.id === selectedProjects[0])?.organization_id) || undefined

                  return (
                    <div>
                      {Array.from(groups.entries()).map(([orgId, group]) => (
                        <div key={orgId} className="border-b border-secondary-200 last:border-0">
                          <div className="px-3 py-2 text-xs font-semibold text-secondary-500 bg-secondary-50 sticky top-0 z-10">
                            {group.name || 'æœªå½’å±ç»„ç»‡'}
                          </div>
                          <ul>
                            {group.items.map(p => {
                              const disabled = selectedOrgId && p.organization_id !== selectedOrgId
                              const checked = selectedProjects.includes(p.id)
                              return (
                                <li
                                  key={p.id}
                                  className={`px-3 py-2 flex items-center gap-2 ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-secondary-50 cursor-pointer'}`}
                                  onClick={() => {
                                    if (disabled) return
                                    setSelectedProjects(prev => prev.includes(p.id) ? prev.filter(id => id !== p.id) : [...prev, p.id])
                                  }}
                                  title={p.name}
                                >
                                  <span className={`w-4 h-4 rounded border-2 flex items-center justify-center ${checked ? 'bg-primary-600 border-primary-600' : 'border-secondary-300'}`}>
                                    {checked && <Check className="h-3 w-3 text-white" />}
                                  </span>
                                  <span className="text-sm text-secondary-800 truncate">{p.name}</span>
                                </li>
                              )
                            })}
                          </ul>
                        </div>
                      ))}
                    </div>
                  )
                })()
              )}
            </div>

            <div className="mt-3 text-xs text-secondary-600">å·²é€‰ {selectedProjects.length} / {userProjects.length}</div>
          </div>
        )}
      </div>
    </div>
  )
} 